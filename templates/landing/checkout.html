{% extends "landing/landing.html" %}
{% load static %}

{% block hero %} {% endblock %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">

    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Complete Your Purchase</h1>
      <p class="text-gray-600 mt-2">Fill in your details and proceed to payment</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- Left Column - Form -->
      <div class="lg:col-span-2 space-y-6">

        <!-- Customer Information -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-6">Customer Information</h2>
          <form id="customer-form">
            {% csrf_token %}
            
            <!-- Personal Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                <input type="text" name="full_name" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                       placeholder="Enter your full name">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                <input type="email" name="email" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                       placeholder="Enter your email">
              </div>
            </div>

            <!-- Contact & Business -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mobile Number (WhatsApp Preferred) *</label>
                <input type="tel" name="mobile_number" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                       placeholder="+91-9876543210">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Company / Agency Name</label>
                <input type="text" name="company_agency_name" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                       placeholder="Your company name (optional)">
              </div>
            </div>

            <!-- Location Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Business Location / City *</label>
                <input type="text" name="business_location_city" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                       placeholder="e.g., Mumbai, Delhi, Bangalore">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Target Area / Location for Leads *</label>
                <input type="text" name="target_area_location" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                       placeholder="e.g., South Delhi, Bandra, Whitefield">
              </div>
            </div>

            <!-- Additional Requirements -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Additional Requirements / Comments</label>
              <textarea name="additional_requirements" rows="4" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                        placeholder="Any specific requirements, preferences, or comments about the leads..."></textarea>
            </div>
          </form>
        </div>

        <!-- Order Summary -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-4">Order Summary</h2>
          <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
            {% if product.product_image %}
              <img src="{{ product.product_image.url }}" alt="{{ product.heading }}" class="w-16 h-16 rounded-lg object-cover">
            {% else %}
              <div class="w-16 h-16 rounded-lg bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                <span class="text-white font-bold text-sm">{{ product.category|slice:":2"|upper }}</span>
              </div>
            {% endif %}
            <div class="flex-1">
              <h3 class="font-semibold text-gray-900">{{ product.heading|default:product.category }}</h3>
              <p class="text-gray-600 text-sm">{{ product.plan_type|title }} Plan • {{ product.unit }}</p>
              <p class="text-gray-500 text-xs mt-1">{{ product.short_description }}</p>
            </div>
            <div class="text-right">
              <p class="font-bold text-gray-900">₹{{ product.price }}</p>
            </div>
          </div>

          <!-- Features List - Fixed -->
            <div class="mt-6">
              <h4 class="font-medium text-gray-900 mb-3">Package Includes:</h4>
              <div class="bg-blue-50 rounded-lg p-4">
                  {% if product.features %}
                      <div class="text-gray-700 text-sm space-y-2">
                          {{ product.features|safe }}
                      </div>
                  {% else %}
                      <p class="text-gray-600 text-sm">No features listed for this product.</p>
                  {% endif %}
              </div>
          </div>
        </div>

      </div>

      <!-- Right Column - Order Total -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 sticky top-8">
          <h2 class="text-xl font-bold text-gray-900 mb-4">Order Total</h2>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Product Price</span>
              <span class="font-medium">₹{{ product.price }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">GST (18%)</span>
              <span class="font-medium">₹{{ gst_amount|default:"0" }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Platform Fee</span>
              <span class="font-medium">₹{{ platform_fee|default:"0" }}</span>
            </div>
            <hr class="my-3 border-gray-200">
            <div class="flex justify-between font-bold text-lg">
              <span>Total Amount</span>
              <span class="text-blue-600">₹{{ total_amount|default:product.price }}</span>
            </div>
          </div>

          <!-- Payment Button -->
          <button id="proceed-to-pay" class="w-full mt-6 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white py-4 rounded-lg font-semibold text-lg transition-all duration-200 shadow-md hover:shadow-lg">
            Proceed to Pay ₹{{ total_amount|default:product.price }}
          </button>

          <!-- Security Badges -->
          <div class="mt-4 text-center">
            <div class="flex items-center justify-center space-x-4 text-xs text-gray-500">
              <div class="flex items-center">
                <i class="fas fa-lock text-green-500 mr-1"></i>
                <span>Secure Payment</span>
              </div>
              <div class="flex items-center">
                <i class="fas fa-shield-alt text-blue-500 mr-1"></i>
                <span>SSL Encrypted</span>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Razorpay Integration -->
<!-- Razorpay Integration - Debug Version -->
<script>
$(document).ready(function(){
  $('#proceed-to-pay').on('click', function(e){
    e.preventDefault();
    console.log('Button clicked - Starting payment process...');

    // Form validation
    const requiredFields = ['full_name', 'email', 'mobile_number', 'business_location_city', 'target_area_location'];
    let isValid = true;
    
    requiredFields.forEach(field => {
      const element = $(`[name="${field}"]`);
      if (!element.val().trim()) {
        isValid = false;
        element.addClass('border-red-500');
        console.log(`Missing required field: ${field}`);
      } else {
        element.removeClass('border-red-500');
      }
    });

    if (!isValid) {
      alert('Please fill all required fields marked with *');
      return;
    }

    // Collect form data
    const formData = {
      full_name: $('input[name="full_name"]').val(),
      email: $('input[name="email"]').val(),
      mobile_number: $('input[name="mobile_number"]').val(),
      company_agency_name: $('input[name="company_agency_name"]').val(),
      business_location_city: $('input[name="business_location_city"]').val(),
      target_area_location: $('input[name="target_area_location"]').val(),
      additional_requirements: $('textarea[name="additional_requirements"]').val(),
      product_category: '{{ product.category }}',
      product_plan_type: '{{ product.plan_type }}',
      csrfmiddlewaretoken: '{{ csrf_token }}'
    };

    console.log('Form data collected:', formData);
    console.log('AJAX URL:', "{% url 'landing:create_order' product.id %}");

    // Show loading state
    const button = $(this);
    const originalText = button.text();
    button.text('Processing...').prop('disabled', true);

    // Create Razorpay order
    $.ajax({
      url: "{% url 'landing:create_order' product.id %}",
      method: "POST",
      data: formData,
      success: function(response){
        console.log('AJAX Success Response:', response);
        
        if (response.success) {
          console.log('Creating Razorpay checkout...');
          
          const options = {
            "key": "{{ RAZORPAY_KEY_ID }}",
            "amount": response.amount,
            "currency": "INR",
            "name": "Optimized Leads",
            "description": "{{ product.heading|default:product.category }} - {{ product.plan_type|title }}",
            "order_id": response.order_id,
            "handler": function(razorpayResponse){
              console.log('Razorpay payment successful:', razorpayResponse);
              
              // Verify payment
              $.ajax({
                url: "{% url 'landing:verify_payment' %}",
                method: "POST",
                data: {
                  razorpay_payment_id: razorpayResponse.razorpay_payment_id,
                  razorpay_order_id: razorpayResponse.razorpay_order_id,
                  razorpay_signature: razorpayResponse.razorpay_signature,
                  csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(verifyResponse){
                  console.log('Payment verification response:', verifyResponse);
                  if (verifyResponse.success) {
                    window.location.href = "{% url 'landing:order_success' %}?order_id=" + razorpayResponse.razorpay_order_id;
                  } else {
                    alert("Payment verification failed: " + (verifyResponse.error || "Unknown error"));
                    button.text(originalText).prop('disabled', false);
                  }
                },
                error: function(xhr, status, error){
                  console.error('Payment verification error:', error, xhr.responseText);
                  alert("Payment verification error. Please contact support.");
                  button.text(originalText).prop('disabled', false);
                }
              });
            },
            "prefill": {
              "name": formData.full_name,
              "email": formData.email,
              "contact": formData.mobile_number
            },
            "theme": {
              "color": "#4F46E5"
            },
            "modal": {
              "ondismiss": function(){
                console.log('Razorpay modal dismissed');
                button.text(originalText).prop('disabled', false);
              }
            }
          };
          
          const rzp = new Razorpay(options);
          rzp.open();
        } else {
          console.error('Order creation failed:', response.error);
          alert("Failed to create order: " + (response.error || "Unknown error"));
          button.text(originalText).prop('disabled', false);
        }
      },
      error: function(xhr, status, error){
        console.error('AJAX Error Details:');
        console.error('Status:', status);
        console.error('Error:', error);
        console.error('Response Text:', xhr.responseText);
        console.error('Ready State:', xhr.readyState);
        console.error('Status Code:', xhr.status);
        
        alert("Failed to create order. Check console for details (F12).");
        button.text(originalText).prop('disabled', false);
      }
    });
  });

  // Remove error styling on input
  $('input, textarea').on('input', function(){
    $(this).removeClass('border-red-500');
  });
});
</script>

<style>
.border-red-500 {
  border-color: #ef4444 !important;
}
</style>
{% endblock %}


{% comment %} {% extends "landing/landing.html" %}
{% load static %}

{% block hero %} {% endblock %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">

    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Checkout</h1>
      <p class="text-gray-600 mt-2">Complete your purchase in just a few steps</p>
    </div>

    <!-- Steps -->
    <div class="mb-8 flex items-center justify-between">
      {% for step in checkout_steps %}
        <div class="flex items-center checkout-step {% if forloop.first %}active{% endif %}">
          <div class="w-8 h-8 rounded-full {% if forloop.first %}bg-indigo-600 text-white{% else %}bg-gray-300 text-gray-600{% endif %} flex items-center justify-center text-sm font-bold">{{ forloop.counter }}</div>
          <span class="ml-2 text-sm font-medium {% if forloop.first %}text-gray-900{% else %}text-gray-500{% endif %}">{{ step }}</span>
        </div>
        {% if not forloop.last %}<div class="flex-1 h-1 bg-gray-200 mx-4"></div>{% endif %}
      {% endfor %}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- Left -->
      <div class="lg:col-span-2 space-y-6">

        <!-- Order Summary -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-4">Order Summary</h2>
          <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
            {% if product.product_image %}
              <img src="{{ product.product_image.url }}" class="w-16 h-16 rounded-lg object-cover">
            {% else %}
              <div class="w-16 h-16 rounded-lg bg-indigo-500 flex items-center justify-center">
                <span class="text-white font-bold">{{ product.category|slice:":2"|upper }}</span>
              </div>
            {% endif %}
            <div class="flex-1">
              <h3 class="font-semibold text-gray-900">{{ product.plan_type|title }} {{ product.category }}</h3>
              <p class="text-gray-600 text-sm">{{ product.short_description }}</p>
            </div>
            <div class="text-right">
              <p class="font-bold text-gray-900">₹{{ product.price }}</p>
            </div>
          </div>

          <div class="mt-4">
            <h4 class="font-medium text-gray-900 mb-2">Package Includes:</h4>
            <ul class="space-y-1 text-sm text-gray-600">
              {% for feature in features_list %}
                <li class="flex items-center">
                  <i class="fas fa-check text-green-500 mr-2 text-xs"></i>{{ feature }}
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <!-- Contact Info -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-4">Contact Information</h2>
          <form id="contact-form">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <input type="text" name="first_name" placeholder="First Name" class="input-field">
              <input type="text" name="last_name" placeholder="Last Name" class="input-field">
            </div>
            <input type="email" name="email" placeholder="Email" class="input-field mt-4">
            <input type="tel" name="phone" placeholder="Phone" class="input-field mt-4">
            <input type="text" name="company" placeholder="Company (Optional)" class="input-field mt-4">
          </form>
        </div>

      </div>

      <!-- Right -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 sticky top-8">
          <h2 class="text-xl font-bold text-gray-900 mb-4">Order Total</h2>
          <div class="space-y-3">
            <div class="flex justify-between"><span>Subtotal</span><span>₹{{ base_price }}</span></div>
            <div class="flex justify-between"><span>GST (18%)</span><span>₹{{ gst_amount }}</span></div>
            <div class="flex justify-between"><span>Platform Fee</span><span>₹{{ platform_fee }}</span></div>
            <hr class="my-3">
            <div class="flex justify-between font-bold text-lg"><span>Total</span><span>₹{{ total_amount }}</span></div>
          </div>

          <button id="complete-order" class="w-full mt-6 bg-indigo-600 text-white py-3 rounded-md">Complete Order</button>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
.input-field {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  margin-bottom: 0.5rem;
}
</style>

<!-- Razorpay Integration -->
<script>
$(document).ready(function(){

  $('#complete-order').on('click', function(e){
    e.preventDefault();

    const data = {
      first_name: $('input[name="first_name"]').val(),
      last_name: $('input[name="last_name"]').val(),
      email: $('input[name="email"]').val(),
      phone: $('input[name="phone"]').val(),
      company: $('input[name="company"]').val(),
      csrfmiddlewaretoken: '{{ csrf_token }}'
    };

    $.ajax({
      url: "{% url 'landing:create_order' product.id %}",
      method: "POST",
      data: data,
      success: function(res){
        const options = {
          "key": "{{ RAZORPAY_KEY_ID }}",
          "amount": res.amount,
          "currency": res.currency,
          "name": "Optimized Leads",
          "description": "{{ product.plan_type|title }} {{ product.category }}",
          "order_id": res.order_id,
          "handler": function(response){
            $.ajax({
              url: "{% url 'landing:verify_payment' %}",
              method: "POST",
              data: {
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
                csrfmiddlewaretoken: '{{ csrf_token }}'
              },
              success: function(resp){
                alert("Payment Successful!");
                window.location.href = "{% url 'landing:order_success' %}?order_id=" + response.razorpay_order_id + "&amount={{ total_amount }}";
              },
              error: function(){
                alert("Payment verification failed!");
              }
            });
          },
          "prefill": {
            "name": data.first_name + " " + data.last_name,
            "email": data.email,
            "contact": data.phone
          },
          "theme": {
            "color": "#6366f1"
          }
        };
        const rzp = new Razorpay(options);
        rzp.open();
      },
      error: function(){
        console.log(xhr.responseText);
        alert("Failed to create order. Try again.");
      }
    });

  });

});
</script>
{% endblock %}
 {% endcomment %}
